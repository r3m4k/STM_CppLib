/** ****************************************************************************
 * @file       SimpleKalman3dFilter.hpp
 * @brief      Заголовочный файл класса SimpleKalman3dFilter - упрощенного 
 *             фильтра Калмана для трехмерных данных
 * 
 * @details    Реализация простого одномерного фильтра Калмана для независимой
 *             фильтрации трех компонент данных (X, Y, Z). Каждая ось 
 *             фильтруется независимо с использованием отдельных параметров 
 *             шума процесса и измерений.
 * 
 * @version    1.0.0
 * @author     Романовский Роман
 * @date       Февраль 2026
 **************************************************************************** */

/* Define to prevent recursive inclusion -------------------------------------*/
#ifndef __SIMPLE_KALMAN_FILTER_HPP
#define __SIMPLE_KALMAN_FILTER_HPP

/* Includes ------------------------------------------------------------------*/
#include <stdint.h>
#include "TriaxialData.hpp"

/* Defines -------------------------------------------------------------------*/

/* Global variables ----------------------------------------------------------*/

// -----------------------------------------------------------------------------
/**
 * @class SimpleKalman3dFilter
 * @brief Упрощенный одномерный фильтр Калмана для трехкомпонентных данных
 * 
 * Класс реализует упрощенный фильтр Калмана для независимой фильтрации 
 * трех компонент данных (X, Y, Z). Каждая ось фильтруется независимо 
 * с использованием отдельных параметров шума.
 * 
 * @note Фильтр предполагает отсутствие динамической модели системы 
 *       (константная модель: x_k = x_{k-1})
 * 
 * @warning Параметры Q и R являются константными и задаются при создании объекта.
 *          Для изменения параметров требуется создание нового фильтра.
 * 
 * @see TriaxialData

 */
class SimpleKalman3dFilter{
private:
    const TriaxialData Q;   /**< Шум процесса (процессная ковариация)       */    
    const TriaxialData R;   /**< Шум измерений (измерительная ковариация)   */
    TriaxialData K;         /**< Коэффициент Калмана (Kalman gain)          */    
    TriaxialData P;         /**< Апостериорная ковариация ошибки оценки     */
public:
    TriaxialData estimate_value;   /**< Текущая оценка состояния            */

public:
    /**
     * @brief Удаленный конструктор по умолчанию
     * @details Запрещает создание фильтра без указания параметров шума.
     */
    SimpleKalman3dFilter() = delete;
    
    /**
     * @brief Основной конструктор фильтра Калмана
     * @param _Q Шум процесса (процессная ковариация)
     * @param _R Шум измерений (измерительная ковариация)
     * 
     * @details Инициализирует фильтр с заданными параметрами шума.
     *          Коэффициент Калмана (K) и ковариация (P) инициализируются нулями.
     *          Начальная оценка состояния также равна нулю.
     * 
     * @warning После создания фильтра параметры Q и R нельзя изменить.
     */
    SimpleKalman3dFilter(
        TriaxialData _Q = TriaxialData(0.0001, 0.0001, 0.0001), 
        TriaxialData _R = TriaxialData(0.005, 0.005, 0.005)
    ): Q(_Q), R(_R), K(), P(), estimate_value() {}
    
    /**
     * @brief Добавить новое измерение и выполнить фильтрацию
     * @param input_value Новое измерение от датчика
     */
    void append_value(const TriaxialData& input_value) {
        TriaxialData pred_value = estimate_value;
        TriaxialData P_pred = P + Q;

        K = P_pred / (P_pred + R);
        estimate_value = pred_value + K * (input_value - pred_value);
        P = (1 - K) * P_pred;
    }
};

#endif /*   __SIMPLE_KALMAN_FILTER_HPP   */